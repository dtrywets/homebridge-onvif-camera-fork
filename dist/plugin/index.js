var xe=Object.create;var Y=Object.defineProperty;var _e=Object.getOwnPropertyDescriptor;var Ie=Object.getOwnPropertyNames;var ke=Object.getPrototypeOf,Le=Object.prototype.hasOwnProperty;var Ne=(r,e)=>()=>(r&&(e=r(r=0)),e);var _=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Me=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Ie(e))!Le.call(r,o)&&o!==t&&Y(r,o,{get:()=>e[o],enumerable:!(i=_e(e,o))||i.enumerable});return r};var Te=(r,e,t)=>(t=r!=null?xe(ke(r)):{},Me(e||!r||!r.__esModule?Y(t,"default",{value:r,enumerable:!0}):t,r));import{fileURLToPath as dt}from"url";import pt from"path";var n=Ne(()=>{"use strict"});var V=_((_t,ae)=>{"use strict";n();var oe=ae.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var e="candidate:%s %d %s %d %s %d typ %s";return e+=r.raddr!=null?" raddr %s rport %d":"%v%v",e+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(e+=" generation %d"),e+=r["network-id"]!=null?" network-id %d":"%v",e+=r["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var e="ssrc:%d";return r.attribute!=null&&(e+=" %s",r.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var e="mediaclk:";return e+=r.id!=null?"id=%s %s":"%v%s",e+=r.mediaClockValue!=null?"=%s":"",e+=r.rateNumerator!=null?" rate=%s":"",e+=r.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(oe).forEach(function(r){var e=oe[r];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})})});var me=_(f=>{"use strict";n();var R=function(r){return String(Number(r))===r?Number(r):r},Oe=function(r,e,t,i){if(i&&!t)e[i]=R(r[1]);else for(var o=0;o<t.length;o+=1)r[o+1]!=null&&(e[t[o]]=R(r[o+1]))},Be=function(r,e,t){var i=r.name&&r.names;r.push&&!e[r.push]?e[r.push]=[]:i&&!e[r.name]&&(e[r.name]={});var o=r.push?{}:i?e[r.name]:e;Oe(t.match(r.reg),o,r.names,r.name),r.push&&e[r.push].push(o)},ne=V(),He=RegExp.prototype.test.bind(/^([a-z])=(.*)/);f.parse=function(r){var e={},t=[],i=e;return r.split(/(\r\n|\r|\n)/).filter(He).forEach(function(o){var a=o[0],s=o.slice(2);a==="m"&&(t.push({rtp:[],fmtp:[]}),i=t[t.length-1]);for(var m=0;m<(ne[a]||[]).length;m+=1){var p=ne[a][m];if(p.reg.test(s))return Be(p,i,s)}}),e.media=t,e};var se=function(r,e){var t=e.split(/=(.+)/,2);return t.length===2?r[t[0]]=R(t[1]):t.length===1&&e.length>1&&(r[t[0]]=void 0),r};f.parseParams=function(r){return r.split(/;\s?/).reduce(se,{})};f.parseFmtpConfig=f.parseParams;f.parsePayloads=function(r){return r.toString().split(" ").map(Number)};f.parseRemoteCandidates=function(r){for(var e=[],t=r.split(" ").map(R),i=0;i<t.length;i+=3)e.push({component:t[i],ip:t[i+1],port:t[i+2]});return e};f.parseImageAttributes=function(r){return r.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(se,{})})};f.parseSimulcastStreamList=function(r){return r.split(";").map(function(e){return e.split(",").map(function(t){var i,o=!1;return t[0]!=="~"?i=R(t):(i=R(t.substring(1,t.length)),o=!0),{scid:i,paused:o}})})}});var de=_((Nt,ce)=>{"use strict";n();var W=V(),De=/%[sdv%]/g,qe=function(r){var e=1,t=arguments,i=t.length;return r.replace(De,function(o){if(e>=i)return o;var a=t[e];switch(e+=1,o){case"%%":return"%";case"%s":return String(a);case"%d":return Number(a);case"%v":return""}})},F=function(r,e,t){var i=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,o=[r+"="+i];if(e.names)for(var a=0;a<e.names.length;a+=1){var s=e.names[a];e.name?o.push(t[e.name][s]):o.push(t[e.names[a]])}else o.push(t[e.name]);return qe.apply(null,o)},$e=["v","o","s","i","u","e","p","c","b","t","r","z","a"],Ge=["i","c","b","a"];ce.exports=function(r,e){e=e||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(a){a.payloads==null&&(a.payloads="")});var t=e.outerOrder||$e,i=e.innerOrder||Ge,o=[];return t.forEach(function(a){W[a].forEach(function(s){s.name in r&&r[s.name]!=null?o.push(F(a,s,r)):s.push in r&&r[s.push]!=null&&r[s.push].forEach(function(m){o.push(F(a,s,m))})})}),r.media.forEach(function(a){o.push(F("m",W.m[0],a)),i.forEach(function(s){W[s].forEach(function(m){m.name in a&&a[m.name]!=null?o.push(F(s,m,a)):m.push in a&&a[m.push]!=null&&a[m.push].forEach(function(p){o.push(F(s,m,p))})})})}),o.join(`\r
`)+`\r
`}});var ue=_(l=>{"use strict";n();var P=me(),Ue=de();l.write=Ue;l.parse=P.parse;l.parseParams=P.parseParams;l.parseFmtpConfig=P.parseFmtpConfig;l.parsePayloads=P.parsePayloads;l.parseRemoteCandidates=P.parseRemoteCandidates;l.parseImageAttributes=P.parseImageAttributes;l.parseSimulcastStreamList=P.parseSimulcastStreamList});n();n();var h="homebridge-onvif-camera",I="homebridge-onvif-camera";n();import{APIEvent as we}from"homebridge";n();n();var k=()=>process.env.DEBUG&&(process.env.DEBUG.includes("ONVIF:Camera")||process.env.DEBUG==="*");var Q=(r,e,t)=>{e.getService(r.hap.Service.AccessoryInformation)?.setCharacteristic(r.hap.Characteristic.Manufacturer,t.information.manufacturer).setCharacteristic(r.hap.Characteristic.Model,t.information.model).setCharacteristic(r.hap.Characteristic.FirmwareRevision,t.information.firmware).setCharacteristic(r.hap.Characteristic.SerialNumber,t.information.serialNumber)},j=(r,e,t)=>{let i=!1;if(e.motionService?.getCharacteristic(r.hap.Characteristic.MotionDetected).onGet(()=>Promise.resolve(i)),e.motionService===void 0&&console.log("motion service is undefined, the recording should not work"),k())(t.getService("Motion Debug Switch")??t.addService(r.hap.Service.Switch,"Motion Debug Switch","Motion-Debug-Switch")).getCharacteristic(r.hap.Characteristic.On).onGet(()=>Promise.resolve(i)).onSet(()=>{i=!i,e.motionService?.updateCharacteristic(r.hap.Characteristic.MotionDetected,i)});else{let o=t.getService("Motion Debug Switch");o!==void 0&&t.removeService(o)}};n();n();import{z as u}from"zod";var ee=u.object({hostname:u.string().min(1),port:u.number().min(1).max(65535),username:u.string().min(1),password:u.string(),timeout:u.number().positive().optional().default(5e3)}),te=u.object({enableMotion:u.boolean().optional().default(!0),motionTimeout:u.number().positive().optional().default(1e3),enableAudio:u.boolean().optional().default(!0),enableTwoWayAudio:u.boolean().optional().default(!1)}),re=u.object({manufacturer:u.string().default("homebridge-onvif-camera"),firmware:u.string().default("0.0.1"),model:u.string().default("homebridge-onvif-camera"),serialNumber:u.string().default("0.0.1")}),ie=u.object({name:u.string().min(1),profile:u.string().min(1),connection:ee,feature:te,information:re}),z=u.object({name:u.string().min(1).optional().default("ONVIF Camera"),platform:u.string().min(1),cameras:ie.array(),ffmpegPath:u.string().min(1).optional().default("ffmpeg")});import{ZodError as at}from"zod";n();import{AudioStreamingCodecType as Qe,AudioStreamingSamplerate as Pe,H264Level as w,H264Profile as A,MediaContainerType as je,SRTPCryptoSuites as et}from"homebridge";n();import{SRTPCryptoSuites as le,StreamRequestTypes as he}from"homebridge";n();var L=r=>r instanceof Error?r:new Error("unknown error");import Je from"node:dgram";n();var fe=Te(ue());import{AudioStreamingCodecType as Ve}from"homebridge";n();import ge from"node:child_process";n();var N=async r=>{await new Promise(e=>setTimeout(e,r))},pe=r=>{let e=()=>{},t=new Promise(i=>{e=i});return r||setTimeout(e,r),{resolver:e,lock:t}};import{EventEmitter as ze}from"events";var S=class extends ze{log;ffmpegPath;started;ffmpegProcess;constructor(e,t="ffmpeg"){super(),this.log=e,this.ffmpegPath=t,this.started=!1}async start(){if(this.started){this.log.warn("the FFmpeg streaming process started before, and can not start it again even it stopped.");return}this.started=!0;let e=await this.buildInputArguments(),t=await this.buildVideoArguments(),i=await this.buildAudioArguments(),o=await this.buildOutputArguments();if(t.length===0&&i.length===0){this.log.error("video info and audio info are not provided, skip streaming camera content");return}this.log.debug("start FFmpeg with output arguments: ",t.join(" "),i.join(" "));let a=["-hide_banner","-loglevel","level+info",...e,...t,...i,...o];this.ffmpegProcess=ge.spawn(this.ffmpegPath,a,{stdio:["pipe","pipe","pipe","pipe"]}),this.ffmpegProcess.on("close",(m,p)=>{this.emit("close",m,p)});let s=m=>{let p=m.toString();p.split(`
`).filter(g=>g.trim().length>0).forEach(g=>{this.log.debug(`[${this.getProcessName()}] ${g}`)});let v=p.split(" ").filter(g=>g.length!==0),C=p.includes("for writing");if(!C){let g=v.indexOf("frame=");if(g===-1||v.length<=g+1)return;let b=v[g+1];C=b!=="0"&&b!=="fps="}!k()&&C&&(this.log.debug("content generated for video/audio, will stop listen on FFmpeg log"),this.emit("content-generated"),this.ffmpegProcess?.stdio[2]?.removeListener("data",s))};this.ffmpegProcess.stdio[2]?.on("data",s),this.setupStdout(this.ffmpegProcess.stdio[1]),this.setupExtraIo(this.ffmpegProcess.stdio[3])}async stop(){if(this.ffmpegProcess!==void 0&&this.ffmpegProcess.exitCode===null){let e=this.ffmpegProcess;this.ffmpegProcess=void 0,await new Promise(t=>{e.on("exit",t),e.stdin?.write(`q
`),N(2e3).then(()=>(e.stdio.forEach(i=>i?.destroy()),N(2e3))).then(()=>e.kill("SIGTERM")).then(()=>N(2e3)).then(()=>e.kill("SIGKILL"))})}}buildInputArguments(){return Promise.resolve([])}buildVideoArguments(){return Promise.resolve([])}buildAudioArguments(){return Promise.resolve([])}buildOutputArguments(){return Promise.resolve([])}setupExtraIo(e){}setupStdout(e){}isCodecSupported=async e=>{let t=ge.spawn(this.ffmpegPath,["-codecs"]),i="";t.stderr.on("data",s=>{i+=s.toString()});let{resolver:o,lock:a}=pe();return t.on("close",o),await a,t.kill("SIGKILL"),i.includes(e)}};import{URLSearchParams as We}from"node:url";var M=class r extends S{ffmpegArgument;constructor(e,t){super(e),this.ffmpegArgument=t}setupExtraIo(e){e?.on("data",t=>{this.emit("sdp-data",fe.parse(t.toString()))})}buildInputArguments(){return Promise.resolve(["-analyzeduration","0","-probesize","512","-re","-i",this.ffmpegArgument.input.resourceAddress,"-live_start_index","-1"])}buildOutputArguments(){return Promise.resolve(["-sdp_file","pipe:3"])}buildVideoArguments(){let{input:e,outputConnection:{video:t},outputContent:{video:i}}=this.ffmpegArgument;if(i===void 0)return Promise.resolve([]);let o=[],a=[];e.video.encoding.toUpperCase().includes("H264")&&e.video.width===i.width&&e.video.height===i.height?o.push("-c:v","copy"):(o.push("-c:v","libx264","-pix_fmt","yuv420p","-preset","ultrafast","-bf","0"),a.push("-filter_complex",`scale=w='min(${i.width.toString()},iw)':h=-2,scale=w=-2:h='min(${i.height.toString()},ih)',pad=${i.width.toString()}:${i.height.toString()}:(ow-iw)/2:(oh-ih)/2,fps=fps=${i.fps.toString()}`));let s=r.buildOutputUrl(t),m=r.buildSrtpArguments(t);return Promise.resolve([...o,"-bsf:v","dump_extra",...a,"-b:v",`${i.maxBitrate.toString()}k`,"-maxrate",`${i.maxBitrate.toString()}k`,"-bufsize",`${(2*i.maxBitrate).toString()}k`,"-g",(4*i.fps).toString(),"-r",i.fps.toString(),...m,"-ssrc",t.ssrc.toString(),"-payload_type",t.payloadType.toString(),"-dn","-sn","-an","-f","rtp",s])}async buildAudioArguments(){let{outputConnection:{audio:e},outputContent:{audio:t}}=this.ffmpegArgument;if(t===void 0)return[];let i=[];if(t.encoding===Ve.AAC_ELD){if(!await this.isCodecSupported("libfdk_aac"))return this.log.warn("your FFmpeg does not enable libfdk_aac, will skip to stream audio"),[];i.push("-c:a","libfdk_aac","-profile:a","aac_eld")}else return this.log.warn(`unsupported audio encoder: ${t.encoding}, will skip to stream audio`),[];let o=r.buildOutputUrl(e),a=r.buildSrtpArguments(e);return[...i,"-ar",`${t.sampleRate.toString()}k`,"-b:a",`${t.maxBitrate.toString()}k`,"-bufsize",`${(t.maxBitrate*4).toString()}k`,"-ac",t.channel.toString(),...a,"-ssrc",e.ssrc.toString(),"-payload_type",e.payloadType.toString(),"-dn","-sn","-vn","-f","rtp",o]}static buildOutputUrl(e){let t=new We,i=`rtp://${e.address}:${e.port.toString()}`;return t.set("rtcpport",e.rtcpPort.toString()),t.set("pkt_size",e.packetSize.toString()),e.srtp?`s${i}?${t.toString()}`:`${i}?${t.toString()}`}static buildSrtpArguments(e){return e.srtp?["-srtp_out_suite",e.srtp.outSuite,"-srtp_out_params",e.srtp.outParams]:[]}getProcessName(){return"FFmpegRtpProcess"}};n();import{spawn as Ze}from"child_process";import{EventEmitter as Ke}from"events";var T=class extends Ke{cmd;child;options;constructor(e,t){super(),this.options=structuredClone(e),this.cmd=t??"ffmpeg"}start(){this.child=Ze(this.cmd,["-hide_banner","-loglevel","level+info","-analyzeduration","0","-probesize","512","-i",this.options.rtspUri,"-vframes","1","-f","mjpeg","-"]),this.child.on("exit",(e,t)=>{this.emit("exit",e,t)}),this.child.on("error",e=>{this.emit("error",e)}),this.child.stdout.on("data",e=>{this.emit("stdout",e)}),this.child.stderr.on("data",e=>{this.emit("stderr",e)})}};var O=class{log;hap;cameraSession;sessions=new Map;constructor(e,t,i){this.log=e,this.hap=t,this.cameraSession=i}handleSnapshotRequest(e,t){this.asyncHandleSnapshotRequest(e,t)}prepareStream(e,t){this.asyncPrepareStream(e).then(i=>{t(void 0,i)}).catch(i=>{t(L(i))})}handleStreamRequest(e,t){this.asyncHandleStreamRequest(e).then(()=>{t()}).catch(i=>{t(L(i))})}asyncHandleSnapshotRequest(e,t){this.log.debug("processing handle snapshot request",e);try{let i=new T({rtspUri:this.cameraSession.broadcastSimulator.getStreamingAddress(),width:e.width,height:e.height}),o=[];i.on("stdout",a=>o.push(a)),i.on("exit",(a,s)=>{s?(this.log.warn("snapshot process was killed with signal: "+s),t(new Error("killed with signal "+s))):a===0?(this.log.debug(`successfully captured snapshot with size ${e.width.toString()}x${e.height.toString()}`),t(void 0,Buffer.concat(o))):(this.log.warn("snapshot process exited with code "+String(a)),t(new Error("Snapshot process exited with code "+String(a))))}),i.start()}catch(i){t(L(i))}}async asyncPrepareStream(e){this.log.debug(`processing prepare stream request: ${JSON.stringify(e)}`);let t=await Z.create(this.log,this.hap,this.cameraSession,e);return this.sessions.set(e.sessionID,t),{video:{port:t.videoRtcpPort,ssrc:t.videoSsrc,srtp_key:e.video.srtp_key,srtp_salt:e.video.srtp_salt},audio:{port:t.audioRtcpPort,ssrc:t.audioSsrc,srtp_key:e.audio.srtp_key,srtp_salt:e.audio.srtp_salt}}}async asyncHandleStreamRequest(e){this.log.debug(`processing handle stream request: ${JSON.stringify(e)}`);let t=this.sessions.get(e.sessionID);if(!t)throw new Error(`session does not exist, session id: ${e.sessionID}`);e.type===he.START?t.startStreaming(e):e.type===he.RECONFIGURE?await t.reconfigureStreaming(e):(this.sessions.delete(e.sessionID),await t.close())}},Z=class r{log;videoRtcpSocket;videoRtcpPort;audioRtcpSocket;audioRtcpPort;camera;videoSsrc;audioSsrc;closed=!1;streamingProcess;prepareStreamRequest;startStreamRequest;constructor(e,t,i,o,a,s,m,p){this.log=e,this.camera=i,this.prepareStreamRequest=o,this.videoRtcpSocket=a,this.videoRtcpPort=s,this.audioRtcpSocket=m,this.audioRtcpPort=p,this.videoSsrc=t.CameraController.generateSynchronisationSource(),this.audioSsrc=t.CameraController.generateSynchronisationSource()}async close(){this.closed||(this.closed=!0,await Promise.all([new Promise(e=>this.videoRtcpSocket.close(e)),new Promise(e=>this.audioRtcpSocket.close(e))]),await this.streamingProcess?.stop())}startStreaming(e){if(this.closed)throw new Error("closed streaming session");if(this.startStreamRequest!==void 0)throw new Error("streaming session can not be start more than once");this.startStreamRequest=e,this.streamingProcess=this.createFFmpegStreamingProcess(),this.streamingProcess.start()}async reconfigureStreaming(e){if(this.closed)throw new Error("closed streaming session");if(this.startStreamRequest===void 0)throw new Error("streaming session haven't started yet");this.startStreamRequest={...this.startStreamRequest,video:{...this.startStreamRequest.video,...e.video}},await this.streamingProcess?.stop(),this.streamingProcess=this.createFFmpegStreamingProcess(),this.streamingProcess.start()}static async create(e,t,i,o){let a=o.addressVersion==="ipv6"?"udp6":"udp4",s=a==="udp4"&&o.sourceAddress.startsWith("::ffff:")?o.sourceAddress.replace("::ffff:",""):o.sourceAddress,{socket:m,port:p}=await r.getPort(a,s),{socket:v,port:C}=await r.getPort(a,s);return new r(e,t,i,o,m,p,v,C)}static async getPort(e,t){let i=Je.createSocket(e);return new Promise((o,a)=>{let s=m=>{i.close(),a(m)};i.on("error",m=>{i.close(),a(m)}),i.bind(0,t,()=>{i.removeListener("error",s),o({socket:i,port:i.address().port})})})}createFFmpegStreamingProcess(){if(this.startStreamRequest===void 0)throw new Error("missing start stream request");let e=this.camera.broadcastSimulator.getVideoStreamingMetadata(),t=this.camera.broadcastSimulator.getAudioStreamingMetadata();return new M(this.log,{ffmpegPath:this.camera.broadcastSimulator.getFFmpegPath(),input:{resourceAddress:this.camera.broadcastSimulator.getStreamingAddress(),video:{width:e.width,height:e.height,encoding:e.encoding},audio:{encoding:t.encoding}},outputConnection:{video:{address:this.prepareStreamRequest.targetAddress,port:this.prepareStreamRequest.video.port,rtcpPort:this.prepareStreamRequest.video.port,localRtpPort:0,localRtcpPort:this.videoRtcpPort,ssrc:this.videoSsrc,payloadType:this.startStreamRequest.video.pt,packetSize:this.startStreamRequest.video.mtu,srtp:this.prepareStreamRequest.video.srtpCryptoSuite!==le.NONE?{outSuite:"AES_CM_128_HMAC_SHA1_80",outParams:Buffer.concat([this.prepareStreamRequest.video.srtp_key,this.prepareStreamRequest.video.srtp_salt]).toString("base64")}:void 0},audio:{address:this.prepareStreamRequest.targetAddress,port:this.prepareStreamRequest.audio.port,rtcpPort:this.prepareStreamRequest.audio.port,localRtpPort:0,localRtcpPort:this.audioRtcpPort,ssrc:this.audioSsrc,payloadType:this.startStreamRequest.audio.pt,packetSize:500,srtp:this.prepareStreamRequest.audio.srtpCryptoSuite!==le.NONE?{outSuite:"AES_CM_128_HMAC_SHA1_80",outParams:Buffer.concat([this.prepareStreamRequest.audio.srtp_key,this.prepareStreamRequest.audio.srtp_salt]).toString("base64")}:void 0}},outputContent:{video:{width:this.startStreamRequest.video.width,height:this.startStreamRequest.video.height,maxBitrate:this.startStreamRequest.video.max_bit_rate,fps:this.startStreamRequest.video.fps},audio:{encoding:this.startStreamRequest.audio.codec,sampleRate:this.startStreamRequest.audio.sample_rate,maxBitrate:this.startStreamRequest.audio.max_bit_rate,packetTime:this.startStreamRequest.audio.packet_time,channel:this.startStreamRequest.audio.channel}}})}};n();import{HDSProtocolSpecificErrorReason as Ce,AudioRecordingSamplerate as y}from"homebridge";n();import{AudioRecordingCodecType as Xe}from"homebridge";var B=class extends S{argument;extraIo;constructor(e,t){super(e),this.argument=structuredClone(t)}getVideoOutput(){return this.extraIo}setupExtraIo(e){this.extraIo=e}buildInputArguments(){return Promise.resolve(["-analyzeduration","0","-probesize","512","-re","-i",this.argument.input.resourceAddress])}buildOutputArguments(){return Promise.resolve(["-movflags","frag_keyframe+empty_moov+default_base_moof+skip_sidx+skip_trailer","-f","mp4","pipe:3"])}buildVideoArguments(){let{input:e,outputContent:{video:t}}=this.argument,i=[],o=[];return e.video.encoding.toUpperCase().includes("H264")&&e.video.width===t.width&&e.video.height===t.height?i.push("-c:v","copy"):(i.push("-c:v","libx264","-pix_fmt","yuv420p","-preset","ultrafast","-bf","0"),o.push("-filter_complex",`scale=w='min(${t.width.toString()},iw)':h=-2,scale=w=-2:h='min(${t.height.toString()},ih)',pad=${t.width.toString()}:${t.height.toString()}:(ow-iw)/2:(oh-ih)/2`)),Promise.resolve([...i,"-bsf:v","dump_extra","-b:v",`${t.maxBitrate.toString()}k`,"-maxrate",`${t.maxBitrate.toString()}k`,"-bufsize",`${(2*t.maxBitrate).toString()}k`,"-g",(4*t.fps).toString(),"-r",t.fps.toString(),...o])}async buildAudioArguments(){let{outputContent:{audio:e}}=this.argument;if(e===void 0)return[];let t=[];if(e.encoding===Xe.AAC_ELD){if(!await this.isCodecSupported("libfdk_aac"))return this.log.warn("your FFmpeg does not enable libfdk_aac, will skip to stream audio"),[];t.push("-c:a","libfdk_aac","-profile:a","aac_eld")}else t.push("-c:a","aac","-profile:a","aac_low");return[...t,"-ar",`${e.sampleRate.toString()}k`,"-b:a",`${e.maxBitrate.toString()}k`,"-bufsize",`${(e.maxBitrate*4).toString()}k`,"-ac",e.channel.toString()]}getProcessName(){return"FFmpegFragmentProcess"}};n();async function*ve(r){for(console.log(r);;){let e=await Se(r,8),t=e.readInt32BE(0)-8,i=e.subarray(4).toString(),o=await Se(r,t);yield{header:e,length:t,type:i,data:o}}}var E=class extends Error{constructor(e){super(`stream ended: ${e}`)}};async function Se(r,e){if(r.readableEnded||r.destroyed)throw new E("readLength start");if(!e)return Buffer.alloc(0);let t=r.read(e);return t||new Promise((i,o)=>{let a=()=>{let p=r.read(e);if(p){m(),i(p);return}(r.readableEnded||r.destroyed)&&o(new E("readLength readable"))},s=()=>{m(),o(new E("readLength end"))},m=()=>{r.removeListener("readable",a),r.removeListener("end",s)};r.on("readable",a),r.on("end",s)})}var H=class r{log;hap;camera;recordingStreaming=new Set;configuration;controller;constructor(e,t,i){this.log=e,this.hap=t,this.camera=i}setCameraController(e){this.controller=e}updateRecordingConfiguration(e){this.log.debug("handle recording configuration change"),this.configuration=e}handleRecordingStreamRequest(e){this.log.debug("handle recording stream request with stream id: ",e);let t=this.handleFragmentsRequests(e);return this.recordingStreaming.add(e),t}closeRecordingStream(e,t){t===void 0?this.log.debug(`recording stream has been closed without reason, streamId: ${e.toString()}`):this.log.debug(`recording stream has been closed with reason: ${t.toString()}, streamId: ${e.toString()}`),this.recordingStreaming.delete(e)}updateRecordingActive(e){}async*handleFragmentsRequests(e){if(this.configuration===void 0)throw this.log.error("invalid state, recording configuration can not be undefined before recording request"),new this.hap.HDSProtocolError(Ce.INVALID_CONFIGURATION);let t=this.controller?.recordingManagement?.operatingModeService.getCharacteristic(this.hap.Characteristic.RecordingAudioActive),i=t!==void 0?t.value===this.hap.Characteristic.RecordingAudioActive.ENABLE:!1,{profile:o}=await this.camera.broadcastSimulator.getCameraHelper().getRtspUriAndProfile(),a=new B(this.log,{ffmpegPath:"ffmpeg",input:{resourceAddress:this.camera.broadcastSimulator.getStreamingAddress(),video:{width:o.videoEncoderConfiguration.resolution.width,height:o.videoEncoderConfiguration.resolution.height,encoding:o.videoEncoderConfiguration.encoding},audio:{encoding:o.audioEncoderConfiguration.encoding}},fragmentLength:4,outputContent:{video:{maxBitrate:this.configuration.videoCodec.parameters.bitRate,fps:this.configuration.videoCodec.resolution[2],width:this.configuration.videoCodec.resolution[0],height:this.configuration.videoCodec.resolution[1]},audio:i?{encoding:this.configuration.audioCodec.type,sampleRate:r.getSampleRateNumber(this.configuration.audioCodec.samplerate),maxBitrate:this.configuration.audioCodec.bitrate,channel:this.configuration.audioCodec.audioChannels??1}:void 0}});this.log.debug("motion recording starting"),await a.start();let s=!1,m=a.getVideoOutput();if(m==null)throw this.log.error("failed to get video output for recording"),new this.hap.HDSProtocolError(Ce.UNEXPECTED_FAILURE);let p=ve(m),v=3*60*1e3,C=setTimeout(()=>{console.error("homekit secure video max duration reached"),s=!0,setTimeout(()=>{a.stop()},1e4)},v),g=[];try{let b=0,J=!0;for await(let Ae of p){if(!this.recordingStreaming.has(e))return;let{header:Fe,type:U,data:Ee}=Ae;if(g.push(Fe,Ee),U==="moov"||U==="mdat"){if(U==="mdat"&&J){g=[],J=!1;continue}if(!this.recordingStreaming.has(e))return;let X=Buffer.concat(g);if(g=[],this.log.debug(`motion fragment #${(++b).toString()} sent. size:`,X.length),yield{data:X,isLast:s},s)break}}}catch(b){console.log(`motion recording error ${b}`)}finally{console.log("motion recording finished"),clearTimeout(C),a.stop()}}static getSampleRateNumber(e){if(Array.isArray(e)&&e.length===0)return 32;switch(Array.isArray(e)?e[0]:e){case y.KHZ_8:return 8;case y.KHZ_16:return 16;case y.KHZ_24:return 24;case y.KHZ_32:return 32;case y.KHZ_44_1:return 44.1;case y.KHZ_48:return 48;default:return 32}}};var be=(r,e,t)=>{let i=new O(r,e.hap,t),o=new H(r,e.hap,t),a=!0,s={cameraStreamCount:2,delegate:i,sensors:{motion:a},recording:a?{options:{prebufferLength:4*1e3,mediaContainerConfiguration:[{type:je.FRAGMENTED_MP4,fragmentLength:4*1e3}],video:{type:e.hap.VideoCodecType.H264,parameters:{profiles:[A.BASELINE,A.MAIN,A.HIGH],levels:[w.LEVEL3_1,w.LEVEL3_2,w.LEVEL4_0]},resolutions:[[1280,720,30],[1920,1080,30]]},audio:{codecs:{type:e.hap.AudioRecordingCodecType.AAC_LC,bitrateMode:e.hap.AudioBitrate.VARIABLE,samplerate:e.hap.AudioRecordingSamplerate.KHZ_32,audioChannels:1}}},delegate:o}:void 0,streamingOptions:{supportedCryptoSuites:[et.AES_CM_128_HMAC_SHA1_80],video:{codec:{profiles:[A.BASELINE,A.MAIN,A.HIGH],levels:[w.LEVEL3_1,w.LEVEL3_2,w.LEVEL4_0]},resolutions:[[3840,2160,30],[2560,1440,30],[1920,1080,30],[1280,960,30],[1280,720,30],[1024,768,30],[640,480,30],[640,360,30],[480,360,30],[480,270,30],[320,240,30],[320,240,15],[320,180,30]]},audio:{twoWayAudio:t.broadcastSimulator.getCameraHelper().getConfig().feature.enableTwoWayAudio,codecs:[{type:Qe.AAC_ELD,samplerate:[Pe.KHZ_16,Pe.KHZ_24]}]}}},m=new e.hap.CameraController(s);return o.setCameraController(m),m};n();import{Cam as tt}from"onvif/promises/index.js";var D=class{cam;cameraConfig;connected;constructor(e){this.cam=new tt(structuredClone(e.connection)),this.cameraConfig=structuredClone(e),this.connected=!1,this.cam.connect().then(()=>{this.connected=!0})}getConfig(){return structuredClone(this.cameraConfig)}async getRtspUriAndProfile(){await this.checkAndTryConnect();let e=(await this.cam.getProfiles()).find(i=>i.$.token===this.cameraConfig.profile);if(e===void 0)throw new Error(`the profile token can not be found in camera profile list, token: ${this.cameraConfig.profile}`);return{rtspUri:(await this.cam.getStreamUri({protocol:"RTSP",profileToken:this.cameraConfig.profile})).uri.replace("://",`://${this.cameraConfig.connection.username}:${this.cameraConfig.connection.password}@`),profile:e}}async checkAndTryConnect(){this.connected||(await this.cam.connect(),this.connected=!0)}};n();n();var q=class extends S{argument;constructor(e,t){super(e,t.ffmpegPath),this.argument=structuredClone(t)}buildInputArguments(){return Promise.resolve(["-analyzeduration","0","-probesize","512","-i",this.argument.rtspUri,"-live_start_index","0"])}buildOutputArguments(){return Promise.resolve(["-f","hls","-hls_time",this.argument.fragmentLength.toString(),"-hls_init_time","1","-hls_list_size",this.argument.fragmentFileSize.toString(),"-hls_delete_threshold","3","-hls_flags","delete_segments+omit_endlist",this.argument.outputPlaylist])}buildVideoArguments(){return Promise.resolve(["-c:v","copy"])}buildAudioArguments(){return Promise.resolve(["-c:a","copy"])}getProcessName(){return"FFmpegLocalBufferProcess"}};import Re from"node:path";import K from"node:fs";var it=4,ye="broadcast_simulator.m3u8",ot=3,$=class{log;outputPath;ffmpegPath;cameraHelper;intervalId;working;videoStreamingMetadata;audioStreamingMetadata;ffmpegProcess;constructor(e,t,i,o){this.log=e,this.cameraHelper=t,this.outputPath=i,this.ffmpegPath=o,this.working=!1,this.checkOrStartFFmpegProcess(),this.intervalId=setInterval(()=>{this.checkOrStartFFmpegProcess()},ot*1e3)}isWorking(){return this.working}getFFmpegPath(){return this.ffmpegPath}getCameraHelper(){return this.cameraHelper}getVideoStreamingMetadata(){if(this.videoStreamingMetadata===void 0)throw new Error("no video streaming metadata available, the broadcast simulator may stopped");return this.videoStreamingMetadata}getAudioStreamingMetadata(){if(this.audioStreamingMetadata===void 0)throw new Error("no audio streaming metadata available, the broadcast simulator may stopped");return this.audioStreamingMetadata}getStreamingAddress(){return"file://"+Re.join(this.outputPath,ye)}async destroy(){clearInterval(this.intervalId),await this.ffmpegProcess?.stop(),K.rmSync(this.outputPath,{force:!0,recursive:!0})}async checkOrStartFFmpegProcess(){if(this.working)return;await this.ffmpegProcess?.stop(),K.rmSync(this.outputPath,{force:!0,recursive:!0}),K.mkdirSync(this.outputPath,{recursive:!0,mode:493});let{rtspUri:e,profile:t}=await this.cameraHelper.getRtspUriAndProfile();this.videoStreamingMetadata={width:t.videoEncoderConfiguration.resolution.width,height:t.videoEncoderConfiguration.resolution.height,fps:t.videoEncoderConfiguration.rateControl.frameRateLimit,maxBitrate:t.videoEncoderConfiguration.rateControl.bitrateLimit,encoding:t.videoEncoderConfiguration.encoding},this.audioStreamingMetadata={encoding:t.audioEncoderConfiguration.encoding,bitrate:t.audioEncoderConfiguration.bitrate,sampleRate:t.audioEncoderConfiguration.sampleRate},this.ffmpegProcess=new q(this.log,{ffmpegPath:this.ffmpegPath,rtspUri:e,outputPlaylist:Re.join(this.outputPath,ye),fragmentLength:it,fragmentFileSize:2,videoInfo:this.videoStreamingMetadata}),this.ffmpegProcess.on("close",()=>{this.working=!1,this.videoStreamingMetadata=void 0,this.audioStreamingMetadata=void 0}),this.working=!0,await this.ffmpegProcess.start()}};import nt from"node:path";var G=class{api;log;config;accessories=[];cameraSession;constructor(e,t,i){this.log=e,this.api=i,this.cameraSession=new Map,this.log.info(`initializing ${I} of ${h} platform...`);try{this.config=z.parse(t)}catch(o){o instanceof at?this.log.warn("incorrect config detected, initialize with empty config",o.message):this.log.warn("unknown error occurred, initialize with empty config",o),this.config={platform:h,cameras:[]}}this.api.on(we.DID_FINISH_LAUNCHING,()=>{this.discoverDevices()}),this.api.on(we.SHUTDOWN,()=>{this.cameraSession.forEach(o=>{o.broadcastSimulator.destroy()})})}configureAccessory(e){this.config.cameras.find(i=>e.UUID===this.api.hap.uuid.generate(i.name))!==void 0?this.accessories.push(e):(this.log.warn("can not found the config for cached accessory, will unregister the accessory, accessory:",e.displayName),this.api.unregisterPlatformAccessories(I,h,[e]))}discoverDevices(){for(let e of this.config.cameras){let t=this.api.hap.uuid.generate(e.name),i=this.accessories.some(o=>o.UUID===t);i||this.accessories.push(new this.api.platformAccessory(e.name,t)),this.cameraSession.set(t,{cachedAccessory:i,broadcastSimulator:new $(this.log,new D(e),nt.join(this.api.user.storagePath(),h,t),this.config.ffmpegPath??"ffmpeg")})}this.accessories.forEach(e=>{let t=this.cameraSession.get(e.UUID);if(t===void 0)return;Q(this.api,e,t.broadcastSimulator.getCameraHelper().getConfig());let i=be(this.log,this.api,t);e.configureController(i),j(this.api,i,e),t.cachedAccessory||this.api.registerPlatformAccessories(I,h,[e])})}};var wi=r=>{r.registerPlatform(h,G)};export{wi as default};
